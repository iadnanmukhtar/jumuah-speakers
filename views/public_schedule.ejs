<%
  const formatDate = d => {
    const dateObj = d instanceof Date ? d : new Date(d);
    if (Number.isNaN(dateObj.getTime())) return d || '';
    return dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
  };

  const formatTime = t => {
    if (!t) return '';
    const [hStr, mStr] = t.split(':');
    const h = parseInt(hStr, 10);
    const m = parseInt(mStr, 10);
    if (Number.isNaN(h) || Number.isNaN(m)) return t;
    const date = new Date();
    date.setHours(h, m, 0, 0);
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  };

  const initials = name => {
    if (!name) return '?';
    const trimmed = name.trim();
    const parts = trimmed.split(/\s+/);
    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
    return trimmed[0].toUpperCase();
  };

  const rangeLabel = (() => {
    const start = dateRange && dateRange.start ? formatDate(dateRange.start) : '';
    const end = dateRange && dateRange.end ? formatDate(dateRange.end) : '';
    if (start && end) return `${start} to ${end}`;
    return start || end;
  })();

  const toDate = d => {
    const dateObj = d instanceof Date ? d : new Date(d);
    return Number.isNaN(dateObj.getTime()) ? null : dateObj;
  };

  const sameDay = (a, b) => {
    if (!a || !b) return false;
    return a.getFullYear() === b.getFullYear()
      && a.getMonth() === b.getMonth()
      && a.getDate() === b.getDate();
  };

  const earliestDate = (() => {
    if (!schedules || schedules.length === 0) return null;
    return toDate(schedules[0].date);
  })();

  const upcomingSlots = (schedules || []).filter(s => {
    const d = toDate(s.date);
    return earliestDate && d && sameDay(d, earliestDate);
  }).sort((a, b) => {
    if (!a.time || !b.time) return 0;
    return a.time.localeCompare(b.time);
  });

  const cutoff = (() => {
    if (!earliestDate) return null;
    const copy = new Date(earliestDate);
    copy.setDate(copy.getDate() + 14);
    return copy;
  })();

  const remaining = (schedules || []).filter(s => {
    const d = toDate(s.date);
    if (!d || !earliestDate) return false;
    if (sameDay(d, earliestDate)) return false;
    if (!cutoff) return true;
    return d <= cutoff;
  });
%>

<section class="space-y-6">
  <div class="bg-gradient-to-r from-emerald-700 via-emerald-600 to-emerald-500 rounded-2xl text-white shadow-md border border-emerald-100">
    <div class="p-6 sm:p-8 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-emerald-100">Public schedule</p>
        <h1 class="text-2xl sm:text-3xl font-semibold">Upcoming Jumuah</h1>
        <p class="text-sm text-emerald-50 mt-1">
          Snapshot of the next three Fridays at Masjid al-Husna
        </p>
      </div>
    </div>

    <% if (upcomingSlots.length > 0) { %>
      <div class="px-6 sm:px-8 pb-6">
        <div class="bg-white/10 border border-white/15 rounded-xl p-5 sm:p-6 shadow-lg backdrop-blur">
          <div class="flex flex-col gap-4 text-white">
            <div>
              <div class="text-xs uppercase tracking-wide text-emerald-100">Next Jumuah</div>
              <div class="text-xl font-semibold"><%= formatDate(upcomingSlots[0].date) %></div>
              <div class="text-sm text-emerald-50">Two khutbah times: 2:00 PM and 2:45 PM</div>
            </div>

            <div class="grid gap-3 sm:grid-cols-2">
              <% upcomingSlots.forEach(slot => { %>
                <div class="bg-white/10 border border-white/15 rounded-lg p-4 flex items-start justify-between gap-3">
                  <div class="space-y-1">
                    <div class="text-sm font-semibold text-white"><%= formatTime(slot.time) %></div>
                    <div class="text-sm text-emerald-50">
                      <span class="font-semibold">Speaker:</span> <%= slot.speaker_name || 'Open slot' %>
                    </div>
                    <div class="text-sm text-emerald-50">
                      <span class="font-semibold">Topic:</span> <%= slot.topic || 'TBD' %>
                    </div>
                    <% if (slot.notes) { %>
                      <div class="text-xs text-emerald-100"><%= slot.notes %></div>
                    <% } %>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    <div class="h-10 w-10 rounded-full overflow-hidden bg-white/20 border border-white/30 flex items-center justify-center text-sm font-semibold">
                      <% if (slot.speaker_avatar) { %>
                        <img src="<%= slot.speaker_avatar %>" alt="<%= slot.speaker_name || 'Open' %>" class="h-full w-full object-cover" />
                      <% } else { %>
                        <span><%= initials(slot.speaker_name || 'Open') %></span>
                      <% } %>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                      <%= slot.status === 'confirmed'
                          ? 'bg-white/80 text-emerald-800'
                          : 'bg-white/30 text-white border border-white/40' %>">
                      <%= slot.status %>
                    </span>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-emerald-100 p-5">
    <% if (!schedules || schedules.length === 0) { %>
      <div class="text-sm text-slate-600">
        No Jumuah entries found in this window. Please check back soon.
      </div>
    <% } else { %>
      <% if (remaining.length === 0) { %>
        <div class="text-sm text-slate-600">
          No additional slots in the next two weeks beyond the upcoming Jumuah.
        </div>
      <% } else { %>
      <div class="sm:hidden space-y-4">
        <% remaining.forEach(s => { %>
          <div class="border border-emerald-100 rounded-lg shadow-sm p-4 bg-white">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-slate-900 font-semibold"><%= formatDate(s.date) %></div>
                <div class="text-sm text-slate-500"><%= formatTime(s.time) %></div>
                <div class="flex items-center gap-2 text-xs text-slate-500 mt-2">
                  <div class="h-8 w-8 rounded-full overflow-hidden bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-700 font-semibold">
                    <% if (s.speaker_avatar) { %>
                      <img src="<%= s.speaker_avatar %>" alt="<%= s.speaker_name || 'Open' %>" class="h-full w-full object-cover" />
                    <% } else { %>
                      <span><%= initials(s.speaker_name || 'Open') %></span>
                    <% } %>
                  </div>
                  <span><%= s.speaker_name || 'Open slot' %></span>
                </div>
              </div>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                <%= s.status === 'confirmed'
                    ? 'bg-emerald-100 text-emerald-800 border border-emerald-300'
                    : 'bg-slate-100 text-slate-700 border border-slate-300' %>">
                <%= s.status %>
              </span>
            </div>
            <div class="mt-3 text-sm text-slate-700">
              <div class="font-medium text-slate-900">Topic</div>
              <div class="mt-1"><%= s.topic || 'TBD' %></div>
            </div>
            <% if (s.notes) { %>
              <div class="mt-2 text-xs text-slate-500"><%= s.notes %></div>
            <% } %>
          </div>
        <% }) %>
      </div>

      <div class="hidden sm:block overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-emerald-50 text-emerald-900">
              <th class="py-2 px-3 text-left">Date</th>
              <th class="py-2 px-3 text-left">Time</th>
              <th class="py-2 px-3 text-left">Speaker</th>
              <th class="py-2 px-3 text-left">Topic</th>
              <th class="py-2 px-3 text-left">Status</th>
              <th class="py-2 px-3 text-left">Notes</th>
            </tr>
          </thead>
          <tbody>
            <% remaining.forEach(s => { %>
              <tr class="border-b border-slate-100">
                <td class="py-2 px-3"><%= formatDate(s.date) %></td>
                <td class="py-2 px-3"><%= formatTime(s.time) %></td>
                <td class="py-2 px-3">
                  <div class="flex items-center gap-2">
                    <div class="h-8 w-8 rounded-full overflow-hidden bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-700 font-semibold">
                      <% if (s.speaker_avatar) { %>
                        <img src="<%= s.speaker_avatar %>" alt="<%= s.speaker_name || 'Open' %>" class="h-full w-full object-cover" />
                      <% } else { %>
                        <span><%= initials(s.speaker_name || 'Open') %></span>
                      <% } %>
                    </div>
                    <span><%= s.speaker_name || 'Open slot' %></span>
                  </div>
                </td>
                <td class="py-2 px-3 text-slate-700"><%= s.topic || 'TBD' %></td>
                <td class="py-2 px-3">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                    <%= s.status === 'confirmed'
                        ? 'bg-emerald-100 text-emerald-800 border border-emerald-300'
                        : 'bg-slate-100 text-slate-700 border border-slate-300' %>">
                    <%= s.status %>
                  </span>
                </td>
                <td class="py-2 px-3 text-slate-500"><%= s.notes || '' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% } %>
    <% } %>
  </div>
</section>
